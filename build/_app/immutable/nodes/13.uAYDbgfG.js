import"../chunks/DsnmJJEf.js";import{d as ie,p as le,u as oe,aQ as pe,i as g,f as F,k as s,r as n,g as e,b as y,s as o,j as k,P as ge,e as l,h as ve,c as ee,a as se,t as Y,l as I,aP as he,O as xe,M as ue,K as _e}from"../chunks/Bq750rDx.js";import{i as C}from"../chunks/BcjopvHb.js";import{s as be,a as ye}from"../chunks/wxUnewq1.js";import{p as ke}from"../chunks/CFwZN-iQ.js";import{g as ce}from"../chunks/C88829DE.js";import{n as j,f as we}from"../chunks/CdRP5_sk.js";import{m as ne}from"../chunks/BkQIuFjj.js";import{A as De}from"../chunks/Bt6DpIqu.js";import{e as Me}from"../chunks/Cjcfrngr.js";import{a as ae}from"../chunks/uSFILAY7.js";import{b as fe}from"../chunks/BL6J_geM.js";import{E as Se}from"../chunks/DIzqhxA9.js";import{b as Ce}from"../chunks/BTSVJW8r.js";import{t as je}from"../chunks/8lBcLtWK.js";var ze=g('<div class="flex items-center justify-center h-full"><div class="text-center text-neutral-500"><p>No messages yet</p> <p class="text-sm mt-1">Start the conversation!</p></div></div>'),Be=g('<div class="flex items-center justify-center my-6"><div class="px-3 py-1 bg-neutral-900 rounded-full text-xs text-neutral-400 font-medium"> </div></div>'),Ue=g('<!> <div><div><div><div class="whitespace-pre-wrap break-words line-clamp-[20] hover:line-clamp-none transition-all"><!></div></div> <div class="text-xs text-neutral-500 px-2"> </div></div></div>',1),Te=g('<button class="fixed bottom-24 right-8 p-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-full shadow-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg></button>'),Ae=g('<div class="flex-1 overflow-y-auto px-4 py-6 space-y-4"><!></div> <!>',1);function He(R,h){le(h,!0);let d=y(null),x=y(!0);function m(r=!0){e(d)&&e(x)&&e(d).scrollTo({top:e(d).scrollHeight,behavior:r?"smooth":"instant"})}function _(){if(!e(d))return;const{scrollTop:r,scrollHeight:a,clientHeight:t}=e(d),v=a-r-t<100;o(x,v)}oe(()=>{h.messages.length>0&&m(h.messages.length>1)}),pe(()=>{m(!1)});function N(r){return new Date(r*1e3).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}function w(r,a){if(!a)return!0;const t=new Date(r.timestamp*1e3).toDateString(),v=new Date(a.timestamp*1e3).toDateString();return t!==v}function z(r){const a=new Date(r*1e3),t=new Date,v=new Date(t);return v.setDate(v.getDate()-1),a.toDateString()===t.toDateString()?"Today":a.toDateString()===v.toDateString()?"Yesterday":a.toLocaleDateString("en-US",{month:"short",day:"numeric",year:a.getFullYear()!==t.getFullYear()?"numeric":void 0})}var B=Ae(),f=F(B),D=s(f);{var S=r=>{var a=ze();l(r,a)},U=r=>{var a=ee(),t=F(a);Me(t,19,()=>h.messages,v=>v.id,(v,M,W)=>{const te=se(()=>e(W)>0?h.messages[e(W)-1]:null);var X=Ue(),Z=F(X);{var re=u=>{var p=Be(),b=s(p),A=s(b,!0);n(b),n(p),Y(L=>I(A,L),[()=>z(e(M).timestamp)]),l(u,p)};C(Z,u=>{w(e(M),e(te))&&u(re)})}var O=k(Z,2),i=s(O),c=s(i),P=s(c),V=s(P);{var K=u=>{{let p=se(()=>new we(j,e(M).rumor));Se(u,{get ndk(){return j},get event(){return e(p)}})}},T=u=>{var p=he();Y(()=>I(p,e(M).content)),l(u,p)};C(V,u=>{e(M).rumor?u(K):u(T,!1)})}n(P),n(c);var E=k(c,2),Q=s(E,!0);n(E),n(i),n(O),Y(u=>{ae(O,1,`flex ${e(M).sender.pubkey===j.activeUser?.pubkey?"justify-end":"justify-start"}`),ae(i,1,`max-w-[70%] ${e(M).sender.pubkey===j.activeUser?.pubkey?"items-end":"items-start"} flex flex-col gap-1`),ae(c,1,`px-4 py-2 rounded-2xl ${e(M).sender.pubkey===j.activeUser?.pubkey?"bg-primary text-primary-foreground rounded-tr-sm":"bg-neutral-900 text-white rounded-tl-sm"}`),I(Q,u)},[()=>N(e(M).timestamp)]),l(v,X)}),l(r,a)};C(D,r=>{h.messages.length===0?r(S):r(U,!1)})}n(f),fe(f,r=>o(d,r),()=>e(d));var H=k(f,2);{var q=r=>{var a=Te();a.__click=()=>{o(x,!0),m()},l(r,a)};C(H,r=>{!e(x)&&h.messages.length>0&&r(q)})}ge("scroll",f,_),l(R,B),ve()}ie(["click"]);var Ee=ue('<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>'),Fe=ue('<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>'),Ne=g('<div class="sticky bottom-0 border-t border-neutral-800/50 bg-black p-4"><div class="flex items-end gap-3"><div class="flex-1 relative"><textarea placeholder="Type a message..." rows="1" class="w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none min-h-[48px] max-h-[200px]"></textarea> <div class="absolute right-3 bottom-3 text-xs text-neutral-600"> </div></div> <button class="px-6 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 h-[48px]"><!></button></div></div>');function Pe(R,h){le(h,!0);let d=y(""),x=y(!1),m=y(null);async function _(){if(!(!e(d).trim()||e(x))){o(x,!0);try{await ne.sendMessage(h.recipient.npub,e(d).trim()),o(d,""),h.onMessageSent?.(),e(m)&&(e(m).style.height="auto")}catch(t){console.error("Failed to send message:",t),je.error("Failed to send message")}finally{o(x,!1)}}}function N(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),_())}function w(){e(m)&&(e(m).style.height="auto",e(m).style.height=`${Math.min(e(m).scrollHeight,200)}px`)}var z=Ne(),B=s(z),f=s(B),D=s(f);xe(D),D.__keydown=N,D.__input=w,fe(D,t=>o(m,t),()=>e(m));var S=k(D,2),U=s(S,!0);n(S),n(f);var H=k(f,2);H.__click=_;var q=s(H);{var r=t=>{var v=Ee();l(t,v)},a=t=>{var v=Fe();l(t,v)};C(q,t=>{e(x)?t(r):t(a,!1)})}n(H),n(B),n(z),Y(t=>{D.disabled=e(x),I(U,e(d).length),H.disabled=t},[()=>!e(d).trim()||e(x)]),Ce(D,()=>e(d),t=>o(d,t)),l(R,z),ve()}ie(["keydown","input","click"]);var Ve=g('<p class="text-xs text-neutral-500 truncate"> </p>'),Ke=g('<!> <div class="flex-1 min-w-0"><h1 class="text-lg font-bold text-white truncate"> </h1> <!></div> <button class="p-2 rounded-lg hover:bg-neutral-800/50 transition-colors text-neutral-400 hover:text-primary" title="View profile"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>',1),Ye=g('<div class="flex-1"><div class="h-5 w-32 bg-neutral-800 rounded animate-pulse"></div></div>'),Ie=g('<div class="flex-1 flex items-center justify-center px-6 text-center"><div><svg class="w-20 h-20 text-neutral-700 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> <h3 class="text-xl font-semibold text-white mb-2">Sign in required</h3> <p class="text-neutral-400 max-w-sm">Please sign in to view and send direct messages</p></div></div>'),Le=g('<div class="flex-1 flex items-center justify-center"><svg class="w-8 h-8 text-primary animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>'),Re=g('<div class="flex-1 flex items-center justify-center px-6 text-center"><div><svg class="w-20 h-20 text-red-500 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <h3 class="text-xl font-semibold text-white mb-2">Error</h3> <p class="text-neutral-400"> </p> <button class="mt-4 px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg transition-colors">Retry</button></div></div>'),qe=g("<!> <!>",1),Oe=g('<div class="h-screen fixed top-0 left-0 right-0 bottom-0 z-[10000] md:h-full md:relative md:z-auto flex flex-col"><div class="sticky top-0 z-10 bg-black border-b border-neutral-800/50 px-4 py-3"><div class="flex items-center gap-3"><button class="p-2 rounded-lg hover:bg-neutral-800/50 transition-colors text-neutral-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button> <!></div></div> <!></div>');function lt(R,h){le(h,!0);const d=()=>ye(ke,"$page",x),[x,m]=be();let _=y(null),N=y(null),w=y(null),z=y(_e([])),B=y(!0),f=y(null),D=y("");const S=se(()=>d().params.npub);let U=y(null);oe(()=>{if(!e(N)){o(U,null);return}j.fetchUser(e(N)).then(i=>{i?.fetchProfile().then(c=>{o(U,c,!0)})})});async function H(){if(!e(S)||!j.$currentUser){o(f,"Invalid conversation"),o(B,!1);return}if(!(e(S)===e(D)&&e(_)))try{o(B,!0),o(f,null),o(D,e(S),!0),o(_,j.getUser({npub:e(S)}),!0),o(N,e(_).pubkey,!0),o(w,await ne.getConversation(e(S)),!0),e(w)&&(o(z,await e(w).getMessages(100),!0),await ne.markConversationAsRead(e(w).id),e(w).on("message",async()=>{o(z,await e(w).getMessages(100),!0)}))}catch(i){console.error("Failed to load conversation:",i),o(f,"Failed to load conversation")}finally{o(B,!1)}}function q(){ce("/messages")}async function r(){e(w)&&o(z,await e(w).getMessages(100),!0)}oe(()=>{e(S)&&j.$currentUser&&H()});var a=Oe(),t=s(a),v=s(t),M=s(v);M.__click=q;var W=k(M,2);{var te=i=>{var c=Ke(),P=F(c);De(P,{get ndk(){return j},get pubkey(){return e(_).pubkey},class:"w-10 h-10"});var V=k(P,2),K=s(V),T=s(K,!0);n(K);var E=k(K,2);{var Q=p=>{var b=Ve(),A=s(b,!0);n(b),Y(()=>I(A,e(U).nip05)),l(p,b)};C(E,p=>{e(U)?.nip05&&p(Q)})}n(V);var u=k(V,2);u.__click=()=>ce(`/p/${e(_).npub}`),Y(()=>I(T,e(U)?.name||e(U)?.displayName||"Anonymous")),l(i,c)},X=i=>{var c=Ye();l(i,c)};C(W,i=>{e(_)?i(te):i(X,!1)})}n(v),n(t);var Z=k(t,2);{var re=i=>{var c=Ie();l(i,c)},O=i=>{var c=ee(),P=F(c);{var V=T=>{var E=Le();l(T,E)},K=T=>{var E=ee(),Q=F(E);{var u=b=>{var A=Re(),L=s(A),G=k(s(L),4),J=s(G,!0);n(G);var $=k(G,2);$.__click=H,n(L),n(A),Y(()=>I(J,e(f))),l(b,A)},p=b=>{var A=ee(),L=F(A);{var G=J=>{var $=qe(),de=F($);He(de,{get messages(){return e(z)}});var me=k(de,2);Pe(me,{get recipient(){return e(_)},onMessageSent:r}),l(J,$)};C(L,J=>{e(_)&&J(G)},!0)}l(b,A)};C(Q,b=>{e(f)?b(u):b(p,!1)},!0)}l(T,E)};C(P,T=>{e(B)?T(V):T(K,!1)},!0)}l(i,c)};C(Z,i=>{j.$currentUser?i(O,!1):i(re)})}n(a),l(R,a),ve(),m()}ie(["click"]);export{lt as component};
