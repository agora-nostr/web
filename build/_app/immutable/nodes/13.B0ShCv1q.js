import{d as le,f as h,j as he,a as s,c as X,s as L,t as xe,i as me}from"../chunks/rzUyzf2y.js";import{p as ve,u as se,aK as _e,f as F,e as n,r as i,g as e,b as y,s as o,d as w,c as de,a as ne,t as q,z as be,x as ye}from"../chunks/AsQG98fS.js";import{i as z}from"../chunks/DZKExFZC.js";import{c as ce}from"../chunks/Dt3q2Svx.js";import{s as we,a as ke}from"../chunks/DfBYFC16.js";import{p as De}from"../chunks/BcDbBYPM.js";import{g as ue}from"../chunks/s53o-P2j.js";import{n as j,f as Me}from"../chunks/tv6-RHC_.js";import{m as ie}from"../chunks/CD9mSG_Y.js";import{U as fe}from"../chunks/C-S0GgRw.js";import{e as Se}from"../chunks/Cztbr3Ea.js";import{a as oe}from"../chunks/CS0aOiUg.js";import{b as pe}from"../chunks/CkKAtl6l.js";import{E as Ce}from"../chunks/cqXEgdME.js";import{b as ze}from"../chunks/DF8Bk5Sh.js";import{t as je}from"../chunks/D7cSTCXZ.js";var Ue=h('<div class="flex items-center justify-center h-full"><div class="text-center text-neutral-500"><p>No messages yet</p> <p class="text-sm mt-1">Start the conversation!</p></div></div>'),Be=h('<div class="flex items-center justify-center my-6"><div class="px-3 py-1 bg-neutral-900 rounded-full text-xs text-neutral-400 font-medium"> </div></div>'),Te=h('<!> <div><div><div><div class="whitespace-pre-wrap break-words line-clamp-[20] hover:line-clamp-none transition-all"><!></div></div> <div class="text-xs text-neutral-500 px-2"> </div></div></div>',1),He=h('<button class="fixed bottom-24 right-8 p-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-full shadow-lg transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg></button>'),Ae=h('<div class="flex-1 overflow-y-auto px-4 py-6 space-y-4"><!></div> <!>',1);function Ee(J,x){ve(x,!0);let d=y(null),_=y(!0);function g(r=!0){e(d)&&e(_)&&e(d).scrollTo({top:e(d).scrollHeight,behavior:r?"smooth":"instant"})}function b(){if(!e(d))return;const{scrollTop:r,scrollHeight:a,clientHeight:t}=e(d),v=a-r-t<100;o(_,v)}se(()=>{x.messages.length>0&&g(x.messages.length>1)}),_e(()=>{g(!1)});function V(r){return new Date(r*1e3).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}function k(r,a){if(!a)return!0;const t=new Date(r.timestamp*1e3).toDateString(),v=new Date(a.timestamp*1e3).toDateString();return t!==v}function U(r){const a=new Date(r*1e3),t=new Date,v=new Date(t);return v.setDate(v.getDate()-1),a.toDateString()===t.toDateString()?"Today":a.toDateString()===v.toDateString()?"Yesterday":a.toLocaleDateString("en-US",{month:"short",day:"numeric",year:a.getFullYear()!==t.getFullYear()?"numeric":void 0})}var B=Ae(),m=F(B),D=n(m);{var C=r=>{var a=Ue();s(r,a)},T=r=>{var a=X(),t=F(a);Se(t,19,()=>x.messages,v=>v.id,(v,M,Z)=>{const re=ne(()=>e(Z)>0?x.messages[e(Z)-1]:null);var $=Te(),ee=F($);{var ae=u=>{var f=Be(),p=n(f),S=n(p,!0);i(p),i(f),q(Y=>L(S,Y),[()=>U(e(M).timestamp)]),s(u,f)};z(ee,u=>{k(e(M),e(re))&&u(ae)})}var Q=w(ee,2),l=n(Q),c=n(l),K=n(c),P=n(K);{var R=u=>{{let f=ne(()=>new Me(j,e(M).rumor));Ce(u,{get ndk(){return j},get event(){return e(f)}})}},H=u=>{var f=xe();q(()=>L(f,e(M).content)),s(u,f)};z(P,u=>{e(M).rumor?u(R):u(H,!1)})}i(K),i(c);var E=w(c,2),W=n(E,!0);i(E),i(l),i(Q),q(u=>{oe(Q,1,`flex ${e(M).sender.pubkey===j.activeUser?.pubkey?"justify-end":"justify-start"}`),oe(l,1,`max-w-[70%] ${e(M).sender.pubkey===j.activeUser?.pubkey?"items-end":"items-start"} flex flex-col gap-1`),oe(c,1,`px-4 py-2 rounded-2xl ${e(M).sender.pubkey===j.activeUser?.pubkey?"bg-primary text-primary-foreground rounded-tr-sm":"bg-neutral-900 text-white rounded-tl-sm"}`),L(W,u)},[()=>V(e(M).timestamp)]),s(v,$)}),s(r,a)};z(D,r=>{x.messages.length===0?r(C):r(T,!1)})}i(m),pe(m,r=>o(d,r),()=>e(d));var A=w(m,2);{var O=r=>{var a=He();a.__click=()=>{o(_,!0),g()},s(r,a)};z(A,r=>{!e(_)&&x.messages.length>0&&r(O)})}he("scroll",m,b),s(J,B),de()}le(["click"]);var Fe=me('<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>'),Ne=me('<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>'),Ve=h('<div class="sticky bottom-0 border-t border-neutral-800/50 bg-black p-4"><div class="flex items-end gap-3"><div class="flex-1 relative"><textarea placeholder="Type a message..." rows="1" class="w-full px-4 py-3 bg-neutral-900 border border-neutral-800 rounded-lg text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none min-h-[48px] max-h-[200px]"></textarea> <div class="absolute right-3 bottom-3 text-xs text-neutral-600"> </div></div> <button class="px-6 py-3 bg-primary hover:bg-primary/90 text-primary-foreground font-semibold rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 h-[48px]"><!></button></div></div>');function Ke(J,x){ve(x,!0);let d=y(""),_=y(!1),g=y(null);async function b(){if(!(!e(d).trim()||e(_))){o(_,!0);try{await ie.sendMessage(x.recipient.npub,e(d).trim()),o(d,""),x.onMessageSent?.(),e(g)&&(e(g).style.height="auto")}catch(t){console.error("Failed to send message:",t),je.error("Failed to send message")}finally{o(_,!1)}}}function V(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),b())}function k(){e(g)&&(e(g).style.height="auto",e(g).style.height=`${Math.min(e(g).scrollHeight,200)}px`)}var U=Ve(),B=n(U),m=n(B),D=n(m);be(D),D.__keydown=V,D.__input=k,pe(D,t=>o(g,t),()=>e(g));var C=w(D,2),T=n(C,!0);i(C),i(m);var A=w(m,2);A.__click=b;var O=n(A);{var r=t=>{var v=Fe();s(t,v)},a=t=>{var v=Ne();s(t,v)};z(O,t=>{e(_)?t(r):t(a,!1)})}i(A),i(B),i(U),q(t=>{D.disabled=e(_),L(T,e(d).length),A.disabled=t},[()=>!e(d).trim()||e(_)]),ze(D,()=>e(d),t=>o(d,t)),s(J,U),de()}le(["keydown","input","click"]);var Pe=h('<p class="text-xs text-neutral-500 truncate"> </p>'),Re=h('<!> <div class="flex-1 min-w-0"><h1 class="text-lg font-bold text-white truncate"> </h1> <!></div> <button class="p-2 rounded-lg hover:bg-neutral-800/50 transition-colors text-neutral-400 hover:text-primary" title="View profile"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></button>',1),Ye=h('<div class="flex-1"><div class="h-5 w-32 bg-neutral-800 rounded animate-pulse"></div></div>'),Ie=h('<div class="flex-1 flex items-center justify-center px-6 text-center"><div><svg class="w-20 h-20 text-neutral-700 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> <h3 class="text-xl font-semibold text-white mb-2">Sign in required</h3> <p class="text-neutral-400 max-w-sm">Please sign in to view and send direct messages</p></div></div>'),Le=h('<div class="flex-1 flex items-center justify-center"><svg class="w-8 h-8 text-primary animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>'),qe=h('<div class="flex-1 flex items-center justify-center px-6 text-center"><div><svg class="w-20 h-20 text-red-500 mb-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <h3 class="text-xl font-semibold text-white mb-2">Error</h3> <p class="text-neutral-400"> </p> <button class="mt-4 px-4 py-2 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg transition-colors">Retry</button></div></div>'),Ge=h("<!> <!>",1),Je=h('<div class="h-screen fixed top-0 left-0 right-0 bottom-0 z-[10000] md:h-full md:relative md:z-auto flex flex-col"><div class="sticky top-0 z-10 bg-black border-b border-neutral-800/50 px-4 py-3"><div class="flex items-center gap-3"><button class="p-2 rounded-lg hover:bg-neutral-800/50 transition-colors text-neutral-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button> <!></div></div> <!></div>');function dt(J,x){ve(x,!0);const d=()=>ke(De,"$page",_),[_,g]=we();let b=y(null),V=y(null),k=y(null),U=y(ye([])),B=y(!0),m=y(null),D=y("");const C=ne(()=>d().params.npub);let T=y(null);se(()=>{if(!e(V)){o(T,null);return}j.fetchUser(e(V)).then(l=>{l?.fetchProfile().then(c=>{o(T,c,!0)})})});async function A(){if(!e(C)||!j.$currentUser){o(m,"Invalid conversation"),o(B,!1);return}if(!(e(C)===e(D)&&e(b)))try{o(B,!0),o(m,null),o(D,e(C),!0),o(b,j.getUser({npub:e(C)}),!0),o(V,e(b).pubkey,!0),o(k,await ie.getConversation(e(C)),!0),e(k)&&(o(U,await e(k).getMessages(100),!0),await ie.markConversationAsRead(e(k).id),e(k).on("message",async()=>{o(U,await e(k).getMessages(100),!0)}))}catch(l){console.error("Failed to load conversation:",l),o(m,"Failed to load conversation")}finally{o(B,!1)}}function O(){ue("/messages")}async function r(){e(k)&&o(U,await e(k).getMessages(100),!0)}se(()=>{e(C)&&j.$currentUser&&A()});var a=Je(),t=n(a),v=n(t),M=n(v);M.__click=O;var Z=w(M,2);{var re=l=>{var c=Re(),K=F(c);ce(K,()=>fe.Root,(f,p)=>{p(f,{get ndk(){return j},get pubkey(){return e(b).pubkey},children:(S,Y)=>{var N=X(),I=F(N);ce(I,()=>fe.Avatar,(G,te)=>{te(G,{class:"w-10 h-10"})}),s(S,N)},$$slots:{default:!0}})});var P=w(K,2),R=n(P),H=n(R,!0);i(R);var E=w(R,2);{var W=f=>{var p=Pe(),S=n(p,!0);i(p),q(()=>L(S,e(T).nip05)),s(f,p)};z(E,f=>{e(T)?.nip05&&f(W)})}i(P);var u=w(P,2);u.__click=()=>ue(`/p/${e(b).npub}`),q(()=>L(H,e(T)?.name||e(T)?.displayName||"Anonymous")),s(l,c)},$=l=>{var c=Ye();s(l,c)};z(Z,l=>{e(b)?l(re):l($,!1)})}i(v),i(t);var ee=w(t,2);{var ae=l=>{var c=Ie();s(l,c)},Q=l=>{var c=X(),K=F(c);{var P=H=>{var E=Le();s(H,E)},R=H=>{var E=X(),W=F(E);{var u=p=>{var S=qe(),Y=n(S),N=w(n(Y),4),I=n(N,!0);i(N);var G=w(N,2);G.__click=A,i(Y),i(S),q(()=>L(I,e(m))),s(p,S)},f=p=>{var S=X(),Y=F(S);{var N=I=>{var G=Ge(),te=F(G);Ee(te,{get messages(){return e(U)}});var ge=w(te,2);Ke(ge,{get recipient(){return e(b)},onMessageSent:r}),s(I,G)};z(Y,I=>{e(b)&&I(N)},!0)}s(p,S)};z(W,p=>{e(m)?p(u):p(f,!1)},!0)}s(H,E)};z(K,H=>{e(B)?H(P):H(R,!1)},!0)}s(l,c)};z(ee,l=>{j.$currentUser?l(Q,!1):l(ae)})}i(a),s(J,a),de(),g()}le(["click"]);export{dt as component};
