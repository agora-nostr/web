import{x as g,u as v,g as p,a as E,s as b,b as N}from"./AsQG98fS.js";import{N as k,K as I,a as _,b as $,c as T,d as q,e as A,f as D}from"./CR7Fa_Et.js";function w(r,a){if(r.kind===$)return"reaction";if(r.kind===T||r.kind===q)return"repost";if(r.kind===A)return"zap";if(r.kind===D)return"invite_acceptance";if(r.kind===I||r.kind===_){const s=r.tags.find(e=>e[0]==="q");if(s&&a.has(s[1]))return"quote";const t=r.tags.find(e=>e[0]==="e"&&e[3]==="reply");return t&&a.has(t[1])?"reply":"mention"}return null}const m={reply:r=>r.map(a=>({id:`reply-${a.id}`,type:"reply",timestamp:a.created_at||0,event:a,replyToEventId:a.tags.find(s=>s[0]==="e"&&s[3]==="reply")?.[1]||""})),mention:r=>r.map(a=>({id:`mention-${a.id}`,type:"mention",timestamp:a.created_at||0,event:a})),quote:r=>r.map(a=>({id:`quote-${a.id}`,type:"quote",timestamp:a.created_at||0,event:a,quotedEventId:a.tags.find(s=>s[0]==="q")?.[1]||""})),reaction:(r,a)=>{const s=new Map;return r.forEach(t=>{const e=t.tags.find(f=>f[0]==="e")?.[1];if(!e||!a.has(e))return;let o=t.content||"ðŸ‘";o==="+"&&(o="â¤ï¸");const d=`${e}-${o}`;s.has(d)||s.set(d,{targetEventId:e,emoji:o,reactors:[],timestamp:t.created_at||0});const u=s.get(d);u.reactors.push({pubkey:t.pubkey,event:t}),t.created_at&&t.created_at>u.timestamp&&(u.timestamp=t.created_at)}),Array.from(s.entries()).map(([t,e])=>({id:`reaction-${t}`,type:"reaction",timestamp:e.timestamp,targetEventId:e.targetEventId,emoji:e.emoji,reactors:e.reactors}))},repost:(r,a)=>{const s=new Map;return r.forEach(t=>{const e=t.tags.find(d=>d[0]==="e")?.[1];if(!e||!a.has(e))return;s.has(e)||s.set(e,{targetEventId:e,reposts:[],timestamp:t.created_at||0});const o=s.get(e);o.reposts.push(t),t.created_at&&t.created_at>o.timestamp&&(o.timestamp=t.created_at)}),Array.from(s.values()).map(t=>({id:`repost-${t.targetEventId}`,type:"repost",timestamp:t.timestamp,targetEventId:t.targetEventId,reposts:t.reposts}))},zap:(r,a)=>{const s=new Map;return r.forEach(t=>{const e=t.tags.find(i=>i[0]==="e")?.[1];if(!e||!a.has(e))return;const o=t.tags.find(i=>i[0]==="bolt11")?.[1],d=z(o),u=t.tags.find(i=>i[0]==="description")?.[1];let f=t.pubkey;if(u)try{f=JSON.parse(u).pubkey||f}catch{}s.has(e)||s.set(e,{targetEventId:e,zaps:[],timestamp:t.created_at||0});const c=s.get(e);c.zaps.push({event:t,amount:d,sender:f}),t.created_at&&t.created_at>c.timestamp&&(c.timestamp=t.created_at)}),Array.from(s.values()).map(t=>({id:`zap-${t.targetEventId}`,type:"zap",timestamp:t.timestamp,targetEventId:t.targetEventId,zaps:t.zaps}))},invite_acceptance:r=>r.map(a=>{const s=a.tags.find(t=>t[0]==="e")?.[1]||"";return{id:`invite-${a.id}`,type:"invite_acceptance",timestamp:a.created_at||0,event:a,inviteeEventId:s,inviteePubkey:a.pubkey}})};function C(r){const a=r.$subscribe(()=>{if(r.$currentUser)return{filters:[{kinds:[...k],"#p":[r.$currentUser.pubkey],since:Math.floor(Date.now()/1e3)-2592e3,limit:500}],subId:"notifications"}}),s=r.$subscribe(()=>{if(r.$currentUser)return{filters:[{kinds:[I,_,30023],authors:[r.$currentUser.pubkey],since:Math.floor(Date.now()/1e3)-3600*24*30}],subId:"user-events"}}),t=E(()=>{const c=Array.from(s.events??[]);return new Set(c.map(n=>n.id))}),e=g(new Map);let o=N("all");const d=E(()=>{if(!r.$currentUser)return[];const c=Array.from(a.events??[]),i=[],n={reply:[],mention:[],quote:[],reaction:[],repost:[],zap:[],invite_acceptance:[]};return c.forEach(l=>{const y=w(l,p(t));y&&n[y].push(l)}),i.push(...m.reply(n.reply)),i.push(...m.mention(n.mention)),i.push(...m.quote(n.quote)),i.push(...m.reaction(n.reaction,p(t))),i.push(...m.repost(n.repost,p(t))),i.push(...m.zap(n.zap,p(t))),i.push(...m.invite_acceptance(n.invite_acceptance)),i.sort((l,y)=>y.timestamp-l.timestamp)});v(()=>{const c=new Set;p(d).forEach(n=>{n.type==="reply"?c.add(n.replyToEventId):n.type==="quote"?c.add(n.quotedEventId):(n.type==="reaction"||n.type==="repost"||n.type==="zap")&&c.add(n.targetEventId)});const i=Array.from(c).filter(n=>!e.has(n));i.length>0&&Promise.all(i.map(n=>r.fetchEvent(n))).then(n=>{n.forEach((h,l)=>{h&&e.set(i[l],h)})})});const u=E(()=>p(o)==="all"?p(d):p(o)==="invite"?p(d).filter(n=>n.type==="invite_acceptance"):p(d).filter(i=>i.type===p(o))),f=E(()=>{const c={all:p(d).length,reply:0,mention:0,quote:0,reaction:0,repost:0,zap:0,invite:0};return p(d).forEach(i=>{i.type==="invite_acceptance"?c.invite++:c[i.type]++}),c});return{get notifications(){return p(u)},get filter(){return p(o)},get counts(){return p(f)},get targetEventsCache(){return e},setFilter(c){b(o,c,!0)}}}function z(r){if(!r)return 0;try{const a=r.match(/lnbc(\d+)([a-z])?/i);if(!a)return 0;const s=parseInt(a[1],10),t=a[2];let e=s;switch(t){case"m":e=s*1e5;break;case"u":e=s*100;break;case"n":e=s/10;break;case"p":e=s/1e4;break}return Math.floor(e)}catch{return 0}}export{C as c};
