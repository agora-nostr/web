import{K as E,u as I,g as c,a as y,s as M,b as _}from"./Bq750rDx.js";import{N as b,K as N,a as v,b as k,c as $,d as q,e as T,f as z}from"./CR7Fa_Et.js";function C(n,o){if(n.kind===k)return"reaction";if(n.kind===$||n.kind===q)return"repost";if(n.kind===T)return"zap";if(n.kind===z)return"invite_acceptance";if(n.kind===N||n.kind===v){const s=n.tags.find(e=>e[0]==="q");if(s&&o.has(s[1]))return"quote";const t=n.tags.find(e=>e[0]==="e"&&e[3]==="reply");return t&&o.has(t[1])?"reply":"mention"}return null}const u={reply:n=>n.map(o=>({id:`reply-${o.id}`,type:"reply",timestamp:o.created_at||0,event:o,replyToEventId:o.tags.find(s=>s[0]==="e"&&s[3]==="reply")?.[1]||""})),mention:n=>n.map(o=>({id:`mention-${o.id}`,type:"mention",timestamp:o.created_at||0,event:o})),quote:n=>n.map(o=>({id:`quote-${o.id}`,type:"quote",timestamp:o.created_at||0,event:o,quotedEventId:o.tags.find(s=>s[0]==="q")?.[1]||""})),reaction:(n,o)=>{const s=new Map;return n.forEach(t=>{const e=t.tags.find(f=>f[0]==="e")?.[1];if(!e||!o.has(e))return;let g=t.content||"ðŸ‘";g==="+"&&(g="â¤ï¸");const l=`${e}-${g}`;s.has(l)||s.set(l,{targetEventId:e,emoji:g,reactors:[],timestamp:t.created_at||0});const p=s.get(l);p.reactors.push({pubkey:t.pubkey,event:t}),t.created_at&&t.created_at>p.timestamp&&(p.timestamp=t.created_at)}),Array.from(s.entries()).map(([t,e])=>({id:`reaction-${t}`,type:"reaction",timestamp:e.timestamp,targetEventId:e.targetEventId,emoji:e.emoji,reactors:e.reactors}))},repost:(n,o)=>{const s=new Map;return n.forEach(t=>{const e=t.tags.find(l=>l[0]==="e")?.[1];if(!e||!o.has(e))return;s.has(e)||s.set(e,{targetEventId:e,reposts:[],timestamp:t.created_at||0});const g=s.get(e);g.reposts.push(t),t.created_at&&t.created_at>g.timestamp&&(g.timestamp=t.created_at)}),Array.from(s.values()).map(t=>({id:`repost-${t.targetEventId}`,type:"repost",timestamp:t.timestamp,targetEventId:t.targetEventId,reposts:t.reposts}))},zap:(n,o)=>{const s=new Map;return n.forEach(t=>{const e=t.tags.find(a=>a[0]==="e")?.[1];if(!e||!o.has(e))return;const g=t.tags.find(a=>a[0]==="bolt11")?.[1],l=D(g),p=t.tags.find(a=>a[0]==="description")?.[1];let f=t.pubkey;if(p)try{f=JSON.parse(p).pubkey||f}catch{}s.has(e)||s.set(e,{targetEventId:e,zaps:[],timestamp:t.created_at||0});const r=s.get(e);r.zaps.push({event:t,amount:l,sender:f}),t.created_at&&t.created_at>r.timestamp&&(r.timestamp=t.created_at)}),Array.from(s.values()).map(t=>({id:`zap-${t.targetEventId}`,type:"zap",timestamp:t.timestamp,targetEventId:t.targetEventId,zaps:t.zaps}))},invite_acceptance:n=>n.map(o=>{const s=o.tags.find(t=>t[0]==="e")?.[1]||"";return{id:`invite-${o.id}`,type:"invite_acceptance",timestamp:o.created_at||0,event:o,inviteeEventId:s,inviteePubkey:o.pubkey}})};function w(n){console.log("[NotificationsManager] Creating notifications manager");const o=n.$subscribe(()=>{if(!n.$currentUser){console.log("[NotificationsManager] No current user, skipping notifications subscription");return}return console.log("[NotificationsManager] Setting up notifications subscription for user:",n.$currentUser.pubkey),{filters:[{kinds:[...b],"#p":[n.$currentUser.pubkey],since:Math.floor(Date.now()/1e3)-3600*24*30,limit:500}],subId:"notifications"}}),s=n.$subscribe(()=>{if(!n.$currentUser){console.log("[NotificationsManager] No current user, skipping user events subscription");return}return console.log("[NotificationsManager] Setting up user events subscription for user:",n.$currentUser.pubkey),{filters:[{kinds:[N,v,30023],authors:[n.$currentUser.pubkey],since:Math.floor(Date.now()/1e3)-3600*24*30}],subId:"user-events"}}),t=y(()=>{console.log("[NotificationsManager] Building user event IDs set");const r=Array.from(s.events??[]);console.log("[NotificationsManager] User events count:",r.length);const a=new Set(r.map(i=>i.id));return console.log("[NotificationsManager] User event IDs count:",a.size),a}),e=E(new Map);let g=_("all");const l=y(()=>{if(console.log("[NotificationsManager] Computing notification groups"),!n.$currentUser)return console.log("[NotificationsManager] No current user, returning empty groups"),[];const r=Array.from(o.events??[]);console.log("[NotificationsManager] Processing",r.length,"notification events");const a=[],i={reply:[],mention:[],quote:[],reaction:[],repost:[],zap:[],invite_acceptance:[]};r.forEach(m=>{const h=C(m,c(t));h&&i[h].push(m)}),console.log("[NotificationsManager] Categorized events:",{reply:i.reply.length,mention:i.mention.length,quote:i.quote.length,reaction:i.reaction.length,repost:i.repost.length,zap:i.zap.length,invite_acceptance:i.invite_acceptance.length}),a.push(...u.reply(i.reply)),a.push(...u.mention(i.mention)),a.push(...u.quote(i.quote)),a.push(...u.reaction(i.reaction,c(t))),a.push(...u.repost(i.repost,c(t))),a.push(...u.zap(i.zap,c(t))),a.push(...u.invite_acceptance(i.invite_acceptance)),console.log("[NotificationsManager] Created",a.length,"notification groups");const d=a.sort((m,h)=>h.timestamp-m.timestamp);return console.log("[NotificationsManager] Sorted notification groups"),d});I(()=>{console.log("[NotificationsManager] Effect running: fetching target events");const r=new Set;c(l).forEach(i=>{i.type==="reply"?r.add(i.replyToEventId):i.type==="quote"?r.add(i.quotedEventId):(i.type==="reaction"||i.type==="repost"||i.type==="zap")&&r.add(i.targetEventId)}),console.log("[NotificationsManager] Target event IDs needed:",r.size);const a=Array.from(r).filter(i=>!e.has(i));console.log("[NotificationsManager] Missing target events:",a.length,"out of",r.size),a.length>0&&(console.log("[NotificationsManager] Fetching missing target events:",a),Promise.all(a.map(i=>n.fetchEvent(i))).then(i=>{console.log("[NotificationsManager] Fetched",i.filter(d=>d).length,"target events"),i.forEach((d,m)=>{d&&e.set(a[m],d)})}))});const p=y(()=>{if(console.log("[NotificationsManager] Filtering notifications with filter:",c(g)),c(g)==="all")return console.log("[NotificationsManager] Returning all",c(l).length,"notifications"),c(l);if(c(g)==="invite"){const a=c(l).filter(i=>i.type==="invite_acceptance");return console.log("[NotificationsManager] Filtered to",a.length,"invite notifications"),a}const r=c(l).filter(a=>a.type===c(g));return console.log("[NotificationsManager] Filtered to",r.length,c(g),"notifications"),r}),f=y(()=>{console.log("[NotificationsManager] Computing counts");const r={all:c(l).length,reply:0,mention:0,quote:0,reaction:0,repost:0,zap:0,invite:0};return c(l).forEach(a=>{a.type==="invite_acceptance"?r.invite++:r[a.type]++}),console.log("[NotificationsManager] Counts:",r),r});return{get notifications(){return console.log("[NotificationsManager] Getting notifications accessor"),c(p)},get filter(){return console.log("[NotificationsManager] Getting filter accessor"),c(g)},get counts(){return console.log("[NotificationsManager] Getting counts accessor"),c(f)},get targetEventsCache(){return console.log("[NotificationsManager] Getting targetEventsCache accessor"),e},setFilter(r){console.log("[NotificationsManager] Setting filter to:",r),M(g,r,!0)}}}function D(n){if(!n)return 0;try{const o=n.match(/lnbc(\d+)([a-z])?/i);if(!o)return 0;const s=parseInt(o[1],10),t=o[2];let e=s;switch(t){case"m":e=s*1e5;break;case"u":e=s*100;break;case"n":e=s/10;break;case"p":e=s/1e4;break}return Math.floor(e)}catch{return 0}}export{w as c};
