import{b as w,K as I,g as C,s as R}from"./Bq750rDx.js";import{g as k,s as v,f as E,n,h as y,W as b,i as P,N as A,j as D}from"./CdRP5_sk.js";import{a as L}from"./L2joq6-K.js";import{n as p}from"./vMgzIjfk.js";const h={invite:null,currentStep:1,selectedCommunity:null,selectedPacks:[],profileData:{name:"",bio:"",location:"",banner:void 0,picture:void 0,nip05:""},hasPublishedInviteConfirmation:!1,hasCompletedInviteSetup:!1};function N(){if(typeof window>"u")return console.log("[Store] Server-side, returning DEFAULT_STATE"),h;try{const c=sessionStorage.getItem("voces-onboarding");if(c){const t=JSON.parse(c);return console.log("[Store] Loaded state from sessionStorage:",t),{...h,...t}}else console.log("[Store] No stored state found, using DEFAULT_STATE")}catch(c){console.error("[Store] Failed to load onboarding state:",c)}return h}function u(c){if(!(typeof window>"u"))try{sessionStorage.setItem("voces-onboarding",JSON.stringify(c))}catch(t){console.error("Failed to save onboarding state:",t)}}class F{#e=w(I(N()));get state(){return C(this.#e)}set state(t){R(this.#e,t,!0)}get invite(){return this.state.invite}get currentStep(){return this.state.currentStep}get selectedCommunity(){return this.state.selectedCommunity}get selectedPacks(){return this.state.selectedPacks}get profileData(){return this.state.profileData}get hasInvite(){return!!this.state.invite}get hasCompletedInviteSetup(){return this.state.hasCompletedInviteSetup}get totalSteps(){return this.hasInvite?4:6}get minStep(){return this.hasInvite?3:1}setInvite(t){if(console.log("[Store] setInvite called with:",t),this.state.invite=t,t.recipientName&&!this.state.profileData.name&&(console.log("[Store] Pre-filling profile name:",t.recipientName),this.state.profileData.name=t.recipientName),t.inviteRelay){const e=k(t.inviteRelay);e&&(console.log(`[Store] Setting language to ${e} based on agora relay ${t.inviteRelay}`),v.setLanguage(e),L.set(e))}console.log("[Store] Setting step to 3 (features)"),this.state.currentStep=3,u(this.state),console.log("[Store] ✓ Invite data saved to sessionStorage")}setStep(t){this.state.currentStep=t,u(this.state)}setSelectedCommunity(t){this.state.selectedCommunity=t,u(this.state)}setSelectedPacks(t){this.state.selectedPacks=t,u(this.state)}setProfileData(t){this.state.profileData={...this.state.profileData,...t},u(this.state)}async publishInviteConfirmation(t){if(console.log("[Store] publishInviteConfirmation called:",{hasPublished:this.state.hasPublishedInviteConfirmation,inviteData:this.state.invite}),this.state.hasPublishedInviteConfirmation){console.log("[Store] ⊘ Invite confirmation already published");return}const e=this.state.invite;if(console.log("[Store] Checking invite data:",{hasInvite:!!e,inviteEventId:e?.inviteEventId,inviter:e?.inviter,inviteRelay:e?.inviteRelay,inviteCode:e?.inviteCode}),!e?.inviteEventId||!e?.inviter||!e?.inviteRelay||!e?.inviteCode){console.warn("[Store] ✗ Missing required invite data for confirmation");return}try{console.log("[Store] Creating kind:514 event...");const i=new E(n);i.kind=514,i.content="",i.tags=[["e",e.inviteEventId],["p",e.inviter],["code",e.inviteCode]],i.isProtected=!0,console.log("[Store] Signing event..."),await i.sign(),console.log("[Store] ✓ Event signed"),console.log("[Store] Getting relay:",e.inviteRelay);const o=n.pool.getRelay(e.inviteRelay,!0);if(o){console.log("[Store] ✓ Relay obtained:",o.url);const s=new y(new Set([o]),n);console.log("[Store] Publishing kind:514 invite confirmation to",e.inviteRelay),await i.publish(s),console.log("[Store] ✓ Successfully published kind:514 invite confirmation"),console.log("[Store] Setting selected relay in settings..."),v.setSelectedRelay(e.inviteRelay),v.relays.find(g=>g.url===e.inviteRelay)?console.log("[Store] Relay already in settings"):(console.log("[Store] Adding relay to settings..."),v.addRelay({url:e.inviteRelay,read:!0,write:!0,enabled:!0})),this.state.hasPublishedInviteConfirmation=!0,u(this.state),console.log("[Store] ✓ Marked as published in state")}else console.error("[Store] ✗ Failed to get relay:",e.inviteRelay)}catch(i){throw console.error("[Store] ✗ Error publishing invite confirmation:",i),i}}async publishProfileAndSetup(t){console.log("[Store] publishProfileAndSetup called for non-invited user");const e=this.state.profileData;if(!e.name){console.warn("[Store] ✗ No profile name, skipping");return}if(!n.$sessions){console.error("[Store] ✗ No sessions manager available");return}try{const o=(await t.user()).npub;p.setEnabled(!0);const s=p.getLightningAddress(),a=new Set;a.add("wss://purplepag.es"),a.add("wss://relay.primal.net"),console.log("[Store] Creating account with createAccount() using existing signer...");const{events:g}=await n.$sessions.createAccount({profile:{name:e.name,about:e.bio,...e.location&&{location:e.location},...e.picture&&{picture:e.picture},...e.nip05&&{nip05:e.nip05},...s&&{lud16:s}},relays:Array.from(a),wallet:{mints:["https://mint.minibits.cash/Bitcoin"],relays:[...b]}},{publish:!1,signer:t});console.log("[Store] ✓ Created signed events:",g.length),console.log("[Store] Publishing events to default relays...");for(const f of g)await f.publish(),console.log(`[Store] ✓ Published kind:${f.kind} to default relays`);console.log("[Store] ✓ Profile and setup complete")}catch(i){throw console.error("[Store] ✗ Error publishing profile and setup:",i),i}}async completeInviteSetup(t){if(console.log("[Store] completeInviteSetup called:",{hasCompletedSetup:this.state.hasCompletedInviteSetup,hasInvite:this.hasInvite}),this.state.hasCompletedInviteSetup){console.log("[Store] ⊘ Invite setup already completed, skipping");return}if(!this.hasInvite){console.log("[Store] ⊘ No invite data, skipping invite setup");return}const e=this.state.invite,i={...this.state.profileData};try{console.log("[Store] Starting invite setup sequence...");let o=[];if(e?.inviter){console.log("[Store] Fetching inviter contacts for:",e.inviter);const r=await n.fetchEvent({kinds:[3],authors:[e.inviter]});if(r){console.log("[Store] ✓ Found inviter contact list");const l=new Set(r.tags.filter(d=>d[0]==="p").map(d=>d[1]).filter(P));l.add(e.inviter),o=Array.from(l),console.log(`[Store] Found ${o.length} contacts from inviter`)}else console.log("[Store] ⊘ No contact list found for inviter, only following inviter"),o=[e.inviter]}let s=["https://mint.minibits.cash/Bitcoin"];if(e?.inviter){console.log("[Store] Fetching inviter mint list (kind 10019) for:",e.inviter);const r=await n.fetchEvent({kinds:[A.CashuMintList],authors:[e.inviter]});if(r){console.log("[Store] ✓ Found inviter mint list event");const l=D.from(r);l?.mints&&l.mints.length>0&&(s=[...l.mints,...s],console.log("[Store] Using inviter mints + default:",s))}else console.log("[Store] ⊘ No mint list found for inviter, using defaults")}const a=new Set;if(e?.inviteRelay&&a.add(e.inviteRelay),a.add("wss://purplepag.es"),a.add("wss://relay.primal.net"),!n.$sessions){console.error("[Store] ✗ No sessions manager available");return}const f=(await t.user()).npub;p.setEnabled(!0);const m=p.getLightningAddress();console.log("[Store] Creating account with createAccount() using existing signer...");const{events:S}=await n.$sessions.createAccount({profile:{name:i.name,about:i.bio,...i.location&&{location:i.location},...i.picture&&{picture:i.picture},...i.nip05&&{nip05:i.nip05},...m&&{lud16:m}},relays:Array.from(a),wallet:{mints:s,relays:[...b]},follows:o},{publish:!1,signer:t});if(console.log("[Store] ✓ Created signed events:",S.length),await this.publishInviteConfirmation(t),e?.inviteRelay&&(console.log("[Store] Publishing events to invite relay:",e.inviteRelay),n.pool.getRelay(e.inviteRelay,!0))){const l=y.fromRelayUrls([e.inviteRelay],n);for(const d of S)await d.publish(l),console.log(`[Store] ✓ Published kind:${d.kind} to invite relay`)}console.log("[Store] Publishing events to default relays...");for(const r of S)await r.publish(),console.log(`[Store] ✓ Published kind:${r.kind} to default relays`);this.state.hasCompletedInviteSetup=!0,u(this.state),console.log("[Store] ✓ Invite setup complete")}catch(o){throw console.error("[Store] ✗ Error during invite setup:",o),o}}clear(){this.state={...h},typeof window<"u"&&sessionStorage.removeItem("voces-onboarding")}}const M=new F;export{M as o};
